{% extends 'base.html' %}

{% block title %}Randevu Oluştur - SAÜ Kuaför{% endblock %}

{% block breadcrumb_items %}
<span class="text-sakarya-blue-400">/ </span>
<a href="{% url 'home' %}" class="text-sakarya-blue-600 hover:text-sakarya-blue-800 transition-colors">Ana Sayfa</a>
<span class="text-sakarya-blue-400"> / Randevu Oluştur</span>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-sakarya-blue-800 mb-4">Yeni Randevu Oluştur</h1>
        <p class="text-gray-600 text-lg">İstediğiniz hizmeti, çalışanı ve uygun zamanı seçerek randevunuzu oluşturun.</p>
    </div>

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <form method="POST" id="appointment-form" class="space-y-6">
            {% csrf_token %}

            <!-- Hizmet Seçimi -->
            <div>
                <label for="service" class="block text-lg font-semibold text-sakarya-blue-800 mb-3">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-sakarya-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>Hizmet Seçimi</span>
                    </div>
                </label>
                <select id="service" name="service" 
                    class="w-full border-2 border-sakarya-blue-100 p-4 rounded-xl focus:border-sakarya-blue-500 focus:ring-2 focus:ring-sakarya-blue-200 transition-all duration-300"
                    hx-get="{% url 'filter_employees' %}"
                    hx-target="#employee"
                    hx-trigger="change"
                    hx-include="this"
                    required>
                    <option value="">Hizmet seçiniz</option>
                    {% for service in services %}
                    <option value="{{ service.id }}">
                        {{ service.name }} ({{ service.duration }} dk - {{ service.price }} TL)
                    </option>
                    {% endfor %}
                </select>
                <p class="text-sm text-gray-500 mt-2">Hangi hizmeti almak istiyorsunuz?</p>
            </div>

            <!-- Çalışan Seçimi -->
            <div>
                <label for="employee" class="block text-lg font-semibold text-sakarya-blue-800 mb-3">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-sakarya-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>Çalışan Seçimi</span>
                    </div>
                </label>
                <select id="employee" name="employee" 
                    class="w-full border-2 border-sakarya-blue-100 p-4 rounded-xl focus:border-sakarya-blue-500 focus:ring-2 focus:ring-sakarya-blue-200 transition-all duration-300 bg-gray-50"
                    hx-get="{% url 'available_times' %}"
                    hx-target="#time"
                    hx-trigger="change"
                    hx-include="#service, #date"
                    disabled
                    required>
                    <option value="">Önce hizmet seçin</option>
                </select>
                <div id="employee-loading" class="hidden mt-2">
                    <div class="flex items-center space-x-2 text-sakarya-blue-600">
                        <div class="w-4 h-4 border-2 border-sakarya-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm">Çalışanlar yükleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- Tarih Seçimi -->
            <div>
                <label for="date" class="block text-lg font-semibold text-sakarya-blue-800 mb-3">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-sakarya-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>Tarih Seçimi</span>
                    </div>
                </label>
                <input type="date" id="date" name="date" 
                    class="w-full border-2 border-sakarya-blue-100 p-4 rounded-xl focus:border-sakarya-blue-500 focus:ring-2 focus:ring-sakarya-blue-200 transition-all duration-300 bg-gray-50"
                    hx-get="{% url 'available_times' %}"
                    hx-target="#time"
                    hx-trigger="change"
                    hx-include="#service, #employee"
                    min="{{ today|date:'Y-m-d' }}"
                    disabled
                    required>
                <p class="text-sm text-gray-500 mt-2">Randevu tarihini seçin</p>
            </div>

            <!-- Saat Seçimi -->
            <div>
                <label for="time" class="block text-lg font-semibold text-sakarya-blue-800 mb-3">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-sakarya-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Saat Seçimi</span>
                    </div>
                </label>
                <select id="time" name="time" 
                    class="w-full border-2 border-sakarya-blue-100 p-4 rounded-xl focus:border-sakarya-blue-500 focus:ring-2 focus:ring-sakarya-blue-200 transition-all duration-300 bg-gray-50"
                    disabled
                    required>
                    <option value="">Önce çalışan ve tarih seçin</option>
                </select>
                <div id="time-loading" class="hidden mt-2">
                    <div class="flex items-center space-x-2 text-sakarya-blue-600">
                        <div class="w-4 h-4 border-2 border-sakarya-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm">Uygun saatler kontrol ediliyor...</span>
                    </div>
                </div>
            </div>

            <!-- Randevu Özeti -->
            <div id="appointment-summary" class="hidden bg-sakarya-blue-50 border border-sakarya-blue-200 rounded-xl p-4">
                <h3 class="font-semibold text-sakarya-blue-800 mb-2">Randevu Özeti</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Hizmet:</span>
                        <span id="summary-service" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Çalışan:</span>
                        <span id="summary-employee" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tarih & Saat:</span>
                        <span id="summary-datetime" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between border-t pt-2">
                        <span class="text-gray-600">Toplam Süre:</span>
                        <span id="summary-duration" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Toplam Tutar:</span>
                        <span id="summary-price" class="font-bold text-sakarya-gold-600">- TL</span>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                class="w-full bg-sakarya-gold-500 hover:bg-sakarya-gold-600 text-white p-4 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                id="submit-btn"
                disabled>
                <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span>Randevuyu Onayla ve Oluştur</span>
                </div>
            </button>
        </form>
    </div>

    <!-- Yardım Bilgisi -->
    <div class="mt-8 bg-sakarya-blue-50 rounded-xl p-6">
        <h3 class="font-semibold text-sakarya-blue-800 mb-4">Randevu Süreci Hakkında</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div class="flex items-start space-x-3">
                <div class="bg-sakarya-blue-100 p-2 rounded-lg">
                    <span class="text-sakarya-blue-600 font-bold">1</span>
                </div>
                <div>
                    <p class="font-medium">Hizmet Seçin</p>
                    <p class="text-gray-600">İstediğiniz kuaförlük hizmetini seçin</p>
                </div>
            </div>
            <div class="flex items-start space-x-3">
                <div class="bg-sakarya-blue-100 p-2 rounded-lg">
                    <span class="text-sakarya-blue-600 font-bold">2</span>
                </div>
                <div>
                    <p class="font-medium">Çalışan & Tarih</p>
                    <p class="text-gray-600">Uygun çalışan ve tarihi belirleyin</p>
                </div>
            </div>
            <div class="flex items-start space-x-3">
                <div class="bg-sakarya-blue-100 p-2 rounded-lg">
                    <span class="text-sakarya-blue-600 font-bold">3</span>
                </div>
                <div>
                    <p class="font-medium">Saat Seçin</p>
                    <p class="text-gray-600">Müsait saatlerden birini seçin</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('service');
    const employeeSelect = document.getElementById('employee');
    const dateInput = document.getElementById('date');
    const timeSelect = document.getElementById('time');
    const submitBtn = document.getElementById('submit-btn');
    const employeeLoading = document.getElementById('employee-loading');
    const timeLoading = document.getElementById('time-loading');
    const appointmentSummary = document.getElementById('appointment-summary');

    // Servis değiştiğinde
    serviceSelect.addEventListener('change', function() {
        const hasService = !!this.value;
        
        employeeSelect.disabled = !hasService;
        dateInput.disabled = !hasService;
        timeSelect.disabled = true;
        
        if (!hasService) {
            employeeSelect.innerHTML = '<option value="">Önce hizmet seçin</option>';
            timeSelect.innerHTML = '<option value="">Önce çalışan ve tarih seçin</option>';
            dateInput.value = '';
            updateSubmitButton();
            hideSummary();
        } else {
            employeeLoading.classList.remove('hidden');
        }
    });

    // Çalışan değiştiğinde
    employeeSelect.addEventListener('change', function() {
        const hasEmployee = !!this.value;
        dateInput.disabled = !hasEmployee;
        timeSelect.disabled = true;
        
        if (!hasEmployee) {
            timeSelect.innerHTML = '<option value="">Önce çalışan ve tarih seçin</option>';
            dateInput.value = '';
        }
        updateSubmitButton();
        updateSummary();
    });

    // Tarih değiştiğinde
    dateInput.addEventListener('change', function() {
        const hasDate = !!this.value;
        timeSelect.disabled = !hasDate;
        
        if (!hasDate) {
            timeSelect.innerHTML = '<option value="">Önce çalışan ve tarih seçin</option>';
        } else {
            timeLoading.classList.remove('hidden');
        }
        updateSubmitButton();
        updateSummary();
    });

    // Saat değiştiğinde
    timeSelect.addEventListener('change', function() {
        updateSubmitButton();
        updateSummary();
    });

    // HTMX event listeners
    document.body.addEventListener('htmx:beforeRequest', function(e) {
        if (e.target.id === 'employee') {
            employeeLoading.classList.remove('hidden');
        }
        if (e.target.id === 'time') {
            timeLoading.classList.remove('hidden');
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(e) {
        if (e.target.id === 'employee') {
            employeeLoading.classList.add('hidden');
        }
        if (e.target.id === 'time') {
            timeLoading.classList.add('hidden');
        }
    });

    function updateSubmitButton() {
        const isFormValid = serviceSelect.value && employeeSelect.value && 
                           dateInput.value && timeSelect.value;
        submitBtn.disabled = !isFormValid;
    }

    function updateSummary() {
        const serviceText = serviceSelect.options[serviceSelect.selectedIndex]?.text || '-';
        const employeeText = employeeSelect.options[employeeSelect.selectedIndex]?.text || '-';
        const dateText = dateInput.value || '-';
        const timeText = timeSelect.options[timeSelect.selectedIndex]?.text || '-';

        if (serviceSelect.value && employeeSelect.value && dateInput.value && timeSelect.value) {
            document.getElementById('summary-service').textContent = serviceText.split(' (')[0];
            document.getElementById('summary-employee').textContent = employeeText;
            document.getElementById('summary-datetime').textContent = `${dateText} ${timeText}`;
            
            // Extract duration and price from service text
            const serviceMatch = serviceText.match(/(\d+) dk - (\d+(?:\.\d+)?) TL/);
            if (serviceMatch) {
                document.getElementById('summary-duration').textContent = serviceMatch[1] + ' dakika';
                document.getElementById('summary-price').textContent = serviceMatch[2] + ' TL';
            }
            
            appointmentSummary.classList.remove('hidden');
        } else {
            hideSummary();
        }
    }

    function hideSummary() {
        appointmentSummary.classList.add('hidden');
    }

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
});
</script>
{% endblock %}